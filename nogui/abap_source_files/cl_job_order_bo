class /s2o/cl_job_order_bo definition
  public
  inheriting from /s2o/cl_object
  create protected

  global friends /s2o/cl_job_order_prop .

  public section.
    types:
      begin of ty_s_material_req.
        include type /s2o/cl_job_order_db_raw=>ty_s_material_req_db.
    types: prod type /s2o/cl_job_order_db_raw=>ty_s_material_req_pr_db,
           inv  type /s2o/cl_job_order_db_raw=>ty_s_material_req_in_db,
           rel  type /s2o/cl_job_order_db_raw=>ty_t_material_req_r_db,
           end of ty_s_material_req .
    types:
      ty_t_material_req type standard table of ty_s_material_req with default key .
    types:
      begin of ty_s_equipment_req.
        include type /s2o/cl_job_order_db_raw=>ty_s_equipment_req_db.
    types: rel type /s2o/cl_job_order_db_raw=>ty_t_equipment_req_r_db,
           end of ty_s_equipment_req .
    types:
      ty_t_equipment_req type standard table of ty_s_equipment_req with default key .
    types:
      begin of ty_s_personnel_req.
        include type /s2o/cl_job_order_db_raw=>ty_s_personnel_req_db.
    types: rel type /s2o/cl_job_order_db_raw=>ty_t_personnel_req_r_db,
           end of ty_s_personnel_req .
    types:
      ty_t_personnel_req type standard table of ty_s_personnel_req with default key .
    types:
      begin of ty_s_phasset_req.
        include type /s2o/cl_job_order_db_raw=>ty_s_asset_req_db.
    types: rel type /s2o/cl_job_order_db_raw=>ty_t_asset_req_r_db,
           end of ty_s_phasset_req .
    types:
      ty_t_phasset_req type standard table of ty_s_phasset_req with default key .

    types ty_s_job_order_attr type /s2o/s_job_order_attr .
    types ty_s_job_order_rel type /s2o/s_job_order_rel .
    types ty_s_job_order_prop type /s2o/s_job_order_prop.

    constants:
      begin of gc_dispatch_state,
        waiting    type /s2o/work_dispatch_state value 'WA',
        pending    type /s2o/work_dispatch_state value 'PE',
        cancelled  type /s2o/work_dispatch_state value 'CA',
        dispatched type /s2o/work_dispatch_state value 'DI',
        ready      type /s2o/work_dispatch_state value 'RE',
        running    type /s2o/work_dispatch_state value 'RU',
        completed  type /s2o/work_dispatch_state value 'CO',
        aborted    type /s2o/work_dispatch_state value 'AB',
        held       type /s2o/work_dispatch_state value 'HE',
        suspended  type /s2o/work_dispatch_state value 'SU',
        closed     type /s2o/work_dispatch_state value 'CL',
        scheduled  type /s2o/work_dispatch_state value 'SC',
      end of gc_dispatch_state.

    constants mc_object_type type /s2o/object_type value /s2o/cl_object=>gc_object_type-job_order.

    methods constructor
      importing
        !iv_object_id type /s2o/object_id
        !iv_readonly  type abap_bool default abap_false .
    methods get
      returning
        value(rs_job_order) type ty_s_job_order_attr .
    methods set
      importing
        !is_job_order type ty_s_job_order_attr .
    methods set_material
      importing
        !it_material_req type ty_t_material_req
      raising
        /sabris/cx_root .
    methods get_material
      returning
        value(rt_material_req) type ty_t_material_req
      raising
        /sabris/cx_root .
    methods get_equipment
      returning
        value(rt_equipment_req) type ty_t_equipment_req
      raising
        /sabris/cx_root .
    methods get_prop
      returning
        value(rs_prop) type ty_s_job_order_prop .
    methods set_prop
      importing
        !is_prop type ty_s_job_order_prop .
    methods get_rel
      returning
        value(rs_rel) type ty_s_job_order_rel .
    methods set_rel
      importing
        !is_rel type ty_s_job_order_rel .

    methods get_description
        redefinition .
  protected section.

    data ms_attr type ty_s_job_order_attr.
    data ms_prop type ty_s_job_order_prop.
    data ms_rel type ty_s_job_order_rel.

    data mt_material_req type ty_t_material_req .
    data mt_phasset_req type ty_t_phasset_req .
    data mt_equipment_req type ty_t_equipment_req .
    data mt_personnel_req type ty_t_personnel_req .

  private section.
    methods:
      get_description_from_work_mast
        returning
          value(rv_description) type /s2o/cl_work_master_db_raw=>ty_s_description.
ENDCLASS.



CLASS /S2O/CL_JOB_ORDER_BO IMPLEMENTATION.


  method constructor.
    super->constructor( iv_object_id =  iv_object_id iv_readonly = iv_readonly ).
    mv_object_type = mc_object_type.
    mv_object_id = iv_object_id.
  endmethod.


  method get.
    rs_job_order = ms_attr.
  endmethod.


  method get_description.
    rv_description = get_description_from_work_mast( ).

    if rv_description is initial.
      rv_description = super->get_description( ).
    endif.
  endmethod.


  method get_description_from_work_mast.
    data(lo_db) = new /s2o/cl_work_master_db( ).
    rv_description = lo_db->read_description(
      iv_work_master_id = ms_rel-work_master_id
      iv_work_master_version = ms_rel-work_master_version ).
  endmethod.


  method get_equipment.
    rt_equipment_req = mt_equipment_req.
  endmethod.


  method get_material.
    rt_material_req = mt_material_req.
  endmethod.


  method get_prop.
    rs_prop = ms_prop.
  endmethod.


  method get_rel.
    rs_rel = ms_rel.
  endmethod.


  method set.
    ms_attr = is_job_order.
  endmethod.


  method set_material.
    mt_material_req = it_material_req.

    loop at mt_material_req assigning field-symbol(<ls_mr>).
      <ls_mr>-job_order_id = mv_object_id.
      loop at <ls_mr>-rel assigning field-symbol(<ls_mr_r>).
        <ls_mr_r>-job_order_id = mv_object_id.
      endloop.
      <ls_mr>-prod-job_order_id = mv_object_id.
    endloop.
  endmethod.


  method set_prop.
    ms_prop = is_prop.
  endmethod.


  method set_rel.
    ms_rel = is_rel.
  endmethod.
ENDCLASS.